{"version":3,"file":"SearchController.js","sources":["SearchController.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2023 Open Pioneer project (https://github.com/open-pioneer)\n// SPDX-License-Identifier: Apache-2.0\nimport { createLogger, isAbortError, throwAbortError } from \"@open-pioneer/core\";\nimport { SearchSource, SearchResult } from \"./api\";\nimport { MapModel } from \"@open-pioneer/map\";\n\nconst LOG = createLogger(\"search:SearchController\");\n\n/**\n * Group of suggestions returned from one source.\n */\nexport interface SuggestionGroup {\n    label: string;\n    source: SearchSource;\n    results: SearchResult[];\n}\n\nconst DEFAULT_SEARCH_TYPING_DELAY = 200;\nconst DEFAULT_MAX_RESULTS_PER_SOURCE = 5;\n\nexport class SearchController {\n    #mapModel: MapModel;\n\n    /**\n     * Search sources defined by the developer.\n     */\n    #sources: SearchSource[] = [];\n\n    /**\n     * Limits the number of results per source.\n     */\n    #maxResultsPerSource: number = DEFAULT_MAX_RESULTS_PER_SOURCE;\n\n    /**\n     * The timeout in millis.\n     */\n    #searchTypingDelay: number = DEFAULT_SEARCH_TYPING_DELAY;\n\n    /**\n     * Cancel or abort a previous request.\n     */\n    #abortController: AbortController | undefined;\n\n    constructor(mapModel: MapModel, sources: SearchSource[]) {\n        this.#mapModel = mapModel;\n        this.#sources = sources;\n    }\n\n    destroy() {\n        this.#abortController?.abort();\n        this.#abortController = undefined;\n    }\n\n    async search(searchTerm: string): Promise<SuggestionGroup[]> {\n        this.#abortController?.abort();\n        this.#abortController = undefined;\n        if (!searchTerm) {\n            return [];\n        }\n\n        const abort = (this.#abortController = new AbortController());\n        try {\n            await waitForTimeOut(abort.signal, this.#searchTypingDelay);\n            if (abort.signal.aborted) {\n                LOG.debug(`search canceled with ${searchTerm}`);\n                throwAbortError();\n            }\n            const settledSearches = await Promise.all(\n                this.#sources.map((source) => this.#searchSource(source, searchTerm, abort.signal))\n            );\n            return settledSearches.filter((s): s is SuggestionGroup => s != null);\n        } finally {\n            if (this.#abortController === abort) {\n                this.#abortController = undefined;\n            }\n        }\n    }\n\n    async #searchSource(\n        source: SearchSource,\n        searchTerm: string,\n        signal: AbortSignal\n    ): Promise<SuggestionGroup | undefined> {\n        const label = source.label;\n        const projection = this.#mapModel.olMap.getView().getProjection();\n        try {\n            const maxResults = this.#maxResultsPerSource;\n            let results = await source.search(searchTerm, {\n                maxResults,\n                signal,\n                mapProjection: projection\n            });\n            if (results.length > maxResults) {\n                results = results.slice(0, maxResults);\n            }\n            return { label, source, results };\n        } catch (e) {\n            if (!isAbortError(e)) {\n                LOG.error(`search for source ${label} failed`, e);\n            }\n            return undefined;\n        }\n    }\n\n    get searchTypingDelay(): number {\n        return this.#searchTypingDelay;\n    }\n\n    set searchTypingDelay(value: number | undefined) {\n        this.#searchTypingDelay = value ?? DEFAULT_SEARCH_TYPING_DELAY;\n    }\n\n    get maxResultsPerSource(): number {\n        return this.#maxResultsPerSource;\n    }\n\n    set maxResultsPerSource(value: number | undefined) {\n        this.#maxResultsPerSource = value ?? DEFAULT_MAX_RESULTS_PER_SOURCE;\n    }\n\n    get sources() {\n        return this.#sources;\n    }\n}\n\n/**\n * wait for timeouts millis or until signal is aborted, whatever happens first\n */\nasync function waitForTimeOut(signal: AbortSignal, timeoutMillis: number) {\n    if (signal.aborted) {\n        return;\n    }\n\n    await new Promise<void>((resolve) => {\n        const done = () => {\n            signal.removeEventListener(\"abort\", done);\n            clearTimeout(timeoutId);\n            resolve();\n        };\n\n        signal.addEventListener(\"abort\", done);\n        const timeoutId = setTimeout(done, timeoutMillis);\n    });\n}\n"],"names":[],"mappings":"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"}