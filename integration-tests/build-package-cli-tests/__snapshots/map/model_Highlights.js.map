{"version":3,"file":"Highlights.js","sources":["Highlights.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2023 Open Pioneer project (https://github.com/open-pioneer)\n// SPDX-License-Identifier: Apache-2.0\n\nimport { Feature } from \"ol\";\nimport OlMap from \"ol/Map\";\nimport { Coordinate } from \"ol/coordinate\";\nimport { Extent, createEmpty, extend, getArea, getCenter } from \"ol/extent\";\nimport { Geometry } from \"ol/geom\";\nimport VectorLayer from \"ol/layer/Vector\";\nimport VectorSource from \"ol/source/Vector\";\nimport { Fill, Icon, Stroke, Style } from \"ol/style\";\nimport { toFunction as toStyleFunction } from \"ol/style/Style\";\nimport {\n    DisplayTarget,\n    Highlight,\n    HighlightOptions,\n    HighlightStyle,\n    HighlightZoomOptions,\n    ZoomOptions\n} from \"../api/MapModel\";\nimport mapMarkerUrl from \"../assets/images/mapMarker.png?url\";\nimport { FeatureLike } from \"ol/Feature\";\nimport { TOPMOST_LAYER_Z } from \"../api\";\nimport { Type } from \"ol/geom/Geometry\";\n\ntype HighlightStyleType = keyof HighlightStyle;\n\nconst DEFAULT_OL_POINT_ZOOM_LEVEL = 17;\nconst DEFAULT_OL_MAX_ZOOM_LEVEL = 20;\nconst DEFAULT_VIEW_PADDING = { top: 50, right: 20, bottom: 10, left: 20 };\n\nexport class Highlights {\n    private olMap: OlMap;\n\n    private olLayer: VectorLayer<Feature<Geometry>>;\n    private olSource: VectorSource<Feature<Geometry>>;\n    private activeHighlights: Set<Highlight>;\n\n    constructor(olMap: OlMap) {\n        this.olMap = olMap;\n        this.olSource = new VectorSource({\n            features: undefined\n        });\n        this.olLayer = new VectorLayer({\n            className: \"highlight-layer\",\n            source: this.olSource,\n            style: function (feature, resolution) {\n                return resolveStyle(feature, resolution);\n            }\n        });\n        this.activeHighlights = new Set();\n        this.olLayer.setZIndex(TOPMOST_LAYER_Z);\n        this.olMap.addLayer(this.olLayer);\n    }\n\n    /**\n     * Getter for Hightlightlayer\n     * @returns Highlights.olLayer\n     */\n    getLayer() {\n        return this.olLayer;\n    }\n\n    /**\n     * This method removes all highlights before destroying the class\n     */\n    destroy() {\n        this.clearHighlight();\n    }\n\n    /**\n     * Method of filtering out objects that are not geometry or have no property geometry.\n     */\n    #filterGeoobjects(geoObjects: DisplayTarget[]): Geometry[] {\n        const geometries: Geometry[] = [];\n        geoObjects.forEach((item) => {\n            if (\"getType\" in item) geometries.push(item);\n            if (\"geometry\" in item && item.geometry) geometries.push(item.geometry);\n        });\n        return geometries;\n    }\n\n    /**\n     * This method displays geometries or BaseFeatures with optional styling in the map\n     */\n    addHighlight(displayTarget: DisplayTarget[], highlightOptions: HighlightOptions | undefined): Highlight {\n        const geometries = this.#filterGeoobjects(displayTarget);\n\n        if (geometries.length === 0) {\n            return {\n                get isActive() {\n                    return false;\n                },\n                destroy() {}\n            };\n        }\n\n        const features = geometries.map((geometry) => {\n            const type = geometry.getType();\n            const feature = new Feature({\n                type: type,\n                geometry: geometry\n            });\n            feature.setStyle(getOwnStyle(type, highlightOptions?.highlightStyle));\n            return feature;\n        });\n\n        const source = this.olSource;\n        const highlights = this.activeHighlights;\n        const highlight: Highlight = {\n            get isActive() {\n                return highlights.has(highlight);\n            },\n            destroy() {\n                if (!this.isActive) {\n                    return;\n                }\n\n                for (const feature of features) {\n                    source.removeFeature(feature);\n                }\n                highlights.delete(highlight);\n            }\n        };\n\n        source.addFeatures(features);\n        this.activeHighlights.add(highlight);\n        return highlight;\n    }\n\n    /**\n     * This method zoom to geometries or BaseFeatures\n     */\n    zoomToHighlight(displayTarget: DisplayTarget[], options: ZoomOptions | undefined) {\n        const geometries = this.#filterGeoobjects(displayTarget);\n\n        if (geometries.length === 0) {\n            return;\n        }\n\n        let extent = createEmpty();\n        for (const geometry of geometries) {\n            extent = extend(extent, geometry!.getExtent());\n        }\n\n        const center = getCenter(extent);\n        const isPoint = getArea(extent) === 0;\n        const zoomScale = isPoint\n            ? options?.pointZoom ?? DEFAULT_OL_POINT_ZOOM_LEVEL\n            : options?.maxZoom ?? DEFAULT_OL_MAX_ZOOM_LEVEL;\n        setCenter(this.olMap, center);\n\n        const {\n            top = 0,\n            right = 0,\n            bottom = 0,\n            left = 0\n        } = options?.viewPadding ?? DEFAULT_VIEW_PADDING;\n        const padding = [top, right, bottom, left];\n        zoomTo(this.olMap, extent, zoomScale, padding);\n    }\n\n    /**\n     * This method displays geometries or BaseFeatures with optional styling in the map and executed a zoom\n     */\n    addHighlightAndZoom(\n        displayTarget: DisplayTarget[],\n        highlightZoomStyle: HighlightZoomOptions | undefined\n    ): Highlight {\n        const result = this.addHighlight(displayTarget, highlightZoomStyle);\n        this.zoomToHighlight(displayTarget, highlightZoomStyle);\n        return result;\n    }\n\n    clearHighlight() {\n        for (const highlight of this.activeHighlights) {\n            highlight.destroy();\n        }\n    }\n}\n\nfunction setCenter(olMap: OlMap, coordinates: Coordinate | undefined) {\n    coordinates && coordinates.length && olMap.getView().setCenter(coordinates);\n}\n\nfunction zoomTo(\n    olMap: OlMap,\n    extent: Extent | undefined,\n    zoomLevel: number | undefined,\n    padding: number[]\n) {\n    if (extent) {\n        olMap.getView().fit(extent, { maxZoom: zoomLevel, padding: padding });\n    } else {\n        zoomLevel && olMap.getView().setZoom(zoomLevel);\n    }\n}\n\n/**\n * Returns the appropriate style from the user's highlightStyle or falls back to the default style\n */\nfunction resolveStyle(feature: FeatureLike, resolution: number) {\n    const type: keyof typeof defaultHighlightStyle = feature.get(\"type\");\n    const style = toStyleFunction(getDefaultStyle(type));\n    return style(feature, resolution);\n}\n\n/**\n * This method creates styling for a highlight based on the optional style information or the default style\n */\nfunction getOwnStyle(type: Type, highlightStyle: HighlightStyle | undefined) {\n    if (highlightStyle && type in highlightStyle) {\n        const supportedType = type as HighlightStyleType;\n        const ownStyle = highlightStyle[supportedType];\n        return ownStyle ? ownStyle : getDefaultStyle(type);\n    } else {\n        return getDefaultStyle(type);\n    }\n}\n\n/**\n * This returns default styling for a highlight\n */\nfunction getDefaultStyle(type: Type) {\n    if (type in defaultHighlightStyle) {\n        const supportedType = type as HighlightStyleType;\n        return defaultHighlightStyle[supportedType];\n    } else {\n        return defaultHighlightStyle.Polygon;\n    }\n}\n\n/**\n * Default styling for highlights\n */\nconst defaultHighlightStyle = {\n    \"Point\": new Style({\n        image: new Icon({\n            anchor: [0.5, 1],\n            src: mapMarkerUrl\n        })\n    }),\n    \"MultiPoint\": new Style({\n        image: new Icon({\n            anchor: [0.5, 1],\n            src: mapMarkerUrl\n        })\n    }),\n    \"LineString\": [\n        new Style({\n            stroke: new Stroke({\n                color: \"#fff\",\n                width: 5\n            })\n        }),\n        new Style({\n            stroke: new Stroke({\n                color: \"#00ffff\",\n                width: 3\n            })\n        })\n    ],\n    \"MultiLineString\": [\n        new Style({\n            stroke: new Stroke({\n                color: \"#fff\",\n                width: 5\n            })\n        }),\n        new Style({\n            stroke: new Stroke({\n                color: \"#00ffff\",\n                width: 3\n            })\n        })\n    ],\n    \"Polygon\": [\n        new Style({\n            stroke: new Stroke({\n                color: \"#fff\",\n                width: 5\n            })\n        }),\n        new Style({\n            stroke: new Stroke({\n                color: \"#00ffff\",\n                width: 3\n            }),\n            fill: new Fill({\n                color: \"rgba(224,255,255,0.35)\"\n            })\n        })\n    ],\n    \"MultiPolygon\": [\n        new Style({\n            stroke: new Stroke({\n                color: \"#fff\",\n                width: 5\n            })\n        }),\n        new Style({\n            stroke: new Stroke({\n                color: \"#00ffff\",\n                width: 3\n            }),\n            fill: new Fill({\n                color: \"rgba(224,255,255,0.35)\"\n            })\n        })\n    ]\n};\n"],"names":["toStyleFunction"],"mappings":"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"}