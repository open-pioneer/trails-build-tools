{"version":3,"file":"createMapModel.js","sources":["createMapModel.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2023 Open Pioneer project (https://github.com/open-pioneer)\n// SPDX-License-Identifier: Apache-2.0\nimport { createLogger } from \"@open-pioneer/core\";\nimport OlMap, { MapOptions } from \"ol/Map\";\nimport View, { ViewOptions } from \"ol/View\";\nimport Attribution from \"ol/control/Attribution\";\nimport { getCenter } from \"ol/extent\";\nimport TileLayer from \"ol/layer/Tile\";\nimport { Projection, get as getProjection } from \"ol/proj\";\nimport OSM from \"ol/source/OSM\";\nimport { DragZoom, defaults as defaultInteractions } from \"ol/interaction\";\nimport { MapBrowserEvent } from \"ol\";\nimport { MapModelImpl } from \"./MapModelImpl\";\nimport { MapConfig } from \"../api\";\nimport { registerProjections } from \"../projections\";\nimport { patchOpenLayersClassesForTesting } from \"../util/ol-test-support\";\nimport { HttpService } from \"@open-pioneer/http\";\n\n/**\n * Register custom projection to the global proj4js definitions. User can select `EPSG:25832`\n * and `EPSG:25833` from the predefined projections without calling `registerProjections`.\n */\nregisterProjections({\n    \"EPSG:25832\":\n        \"+proj=utm +zone=32 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs\",\n    \"EPSG:25833\":\n        \"+proj=utm +zone=33 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs\"\n});\nconst LOG = createLogger(\"map:createMapModel\");\n\nexport async function createMapModel(\n    mapId: string,\n    mapConfig: MapConfig,\n    httpService: HttpService\n): Promise<MapModelImpl> {\n    return await new MapModelFactory(mapId, mapConfig, httpService).createMapModel();\n}\n\nclass MapModelFactory {\n    private mapId: string;\n    private mapConfig: MapConfig;\n    private httpService: HttpService;\n\n    constructor(mapId: string, mapConfig: MapConfig, httpService: HttpService) {\n        this.mapId = mapId;\n        this.mapConfig = mapConfig;\n        this.httpService = httpService;\n    }\n\n    async createMapModel() {\n        const mapId = this.mapId;\n        const mapConfig = this.mapConfig;\n        const { view: viewOption, ...rawOlOptions } = mapConfig.advanced ?? {};\n        const mapOptions: MapOptions = {\n            ...rawOlOptions\n        };\n\n        if (!mapOptions.controls) {\n            mapOptions.controls = [new Attribution({ collapsible: false })];\n        }\n\n        if (!mapOptions.interactions) {\n            const shiftCtrlKeysOnly = (mapBrowserEvent: MapBrowserEvent<KeyboardEvent>) => {\n                const originalEvent = mapBrowserEvent.originalEvent;\n                return (originalEvent.metaKey || originalEvent.ctrlKey) && originalEvent.shiftKey;\n            };\n            /*\n             * setting altShiftDragRotate to false disables or excludes DragRotate interaction\n             * */\n            mapOptions.interactions = defaultInteractions({\n                dragPan: true,\n                altShiftDragRotate: false,\n                pinchRotate: false,\n                mouseWheelZoom: true\n            }).extend([new DragZoom({ out: true, condition: shiftCtrlKeysOnly })]);\n        }\n\n        const view = (await viewOption) ?? {};\n        this.initializeViewOptions(view);\n        mapOptions.view = view instanceof View ? view : new View(view);\n\n        if (!mapOptions.layers && !mapConfig.layers) {\n            mapOptions.layers = [\n                new TileLayer({\n                    source: new OSM()\n                })\n            ];\n        }\n\n        const initialView = mapConfig.initialView;\n        const initialExtent = initialView?.kind === \"extent\" ? initialView.extent : undefined;\n\n        LOG.debug(`Constructing OpenLayers map with options`, mapOptions);\n\n        if (import.meta.env.VITEST) {\n            patchOpenLayersClassesForTesting();\n        }\n\n        const olMap = new OlMap(mapOptions);\n\n        const mapModel = new MapModelImpl({\n            id: mapId,\n            olMap,\n            initialExtent,\n            httpService: this.httpService\n        });\n\n        try {\n            if (mapConfig.layers) {\n                for (const layerConfig of mapConfig.layers) {\n                    mapModel.layers.addLayer(layerConfig);\n                }\n            }\n            return mapModel;\n        } catch (e) {\n            mapModel.destroy();\n            throw e;\n        }\n    }\n\n    private initializeViewOptions(view: View | ViewOptions) {\n        const mapId = this.mapId;\n        const mapConfig = this.mapConfig;\n        if (view instanceof View) {\n            const warn = (prop: string) => {\n                LOG.warn(\n                    `The advanced configuration for map id '${mapId}' has provided a fully constructed view instance: ${prop} cannot be applied.\\n` +\n                        `Use ViewOptions instead of a View instance.`\n                );\n            };\n\n            if (mapConfig.projection != null) {\n                warn(\"projection\");\n            }\n            if (mapConfig.initialView != null) {\n                warn(\"initialView\");\n            }\n            return;\n        }\n\n        const projection = (view.projection = this.initializeProjection(mapConfig.projection));\n        const initialView = mapConfig.initialView;\n        if (initialView) {\n            switch (initialView.kind) {\n                case \"position\":\n                    view.zoom = initialView.zoom;\n                    view.center = [initialView.center.x, initialView.center.y];\n                    break;\n                case \"extent\": {\n                    /*\n                        OpenLayers does not support configuration of the initial map extent.\n                        The only relevant options here are center, zoom (and resolution).\n                        We must set those values because otherwise OpenLayers will not initialize layer sources.\n\n                        The actual initial extent is applied once tha map has loaded and its size is known.\n                    */\n                    const extent = initialView.extent;\n                    view.zoom = 0;\n                    view.center = [\n                        extent.xMin + (extent.xMax - extent.xMin) / 2,\n                        extent.yMin + (extent.yMax - extent.yMin) / 2\n                    ];\n                    break;\n                }\n            }\n        } else {\n            this.setViewDefaults(view, projection);\n        }\n    }\n\n    private setViewDefaults(view: ViewOptions, projection: Projection) {\n        if (view.center == null) {\n            const extent = projection.getExtent(); // can be null\n            if (!extent) {\n                LOG.warn(\n                    `Cannot set default center coordinate because the current projection has no associated extent.\\n` +\n                        `Try to configure 'initialView' explicity.`\n                );\n            } else {\n                view.center = getCenter(extent);\n            }\n        }\n\n        if (view.zoom == null || view.resolution == null) {\n            view.zoom = 0;\n        }\n    }\n\n    private initializeProjection(projectionOption: MapConfig[\"projection\"]) {\n        if (projectionOption == null) {\n            return getProjection(\"EPSG:3857\")!; // default OpenLayers projection\n        }\n\n        const projection = getProjection(projectionOption);\n        if (!projection) {\n            throw new Error(`Failed to retrieve projection for code '${projectionOption}'.`);\n        }\n        return projection;\n    }\n}\n"],"names":["defaultInteractions","getProjection"],"mappings":"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"}