{"version":3,"file":"WMSLayerImpl.js","sources":["WMSLayerImpl.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2023 Open Pioneer project (https://github.com/open-pioneer)\n// SPDX-License-Identifier: Apache-2.0\nimport { createLogger, isAbortError } from \"@open-pioneer/core\";\nimport { ImageWrapper } from \"ol\";\nimport WMSCapabilities from \"ol/format/WMSCapabilities\";\nimport ImageLayer from \"ol/layer/Image\";\nimport type ImageSource from \"ol/source/Image\";\nimport ImageWMS from \"ol/source/ImageWMS\";\nimport { WMSLayer, WMSLayerConfig, WMSSublayer, WMSSublayerConfig } from \"../../api\";\nimport { fetchCapabilities } from \"../../util/capabilities-utils\";\nimport { DeferredExecution, defer } from \"../../util/defer\";\nimport { AbstractLayer } from \"../AbstractLayer\";\nimport { AbstractLayerBase } from \"../AbstractLayerBase\";\nimport { MapModelImpl } from \"../MapModelImpl\";\nimport { SublayersCollectionImpl } from \"../SublayersCollectionImpl\";\n\nconst LOG = createLogger(\"map:WMSLayer\");\n\nexport class WMSLayerImpl extends AbstractLayer implements WMSLayer {\n    #url: string;\n    #sublayers: SublayersCollectionImpl<WMSSublayerImpl>;\n    #deferredSublayerUpdate: DeferredExecution | undefined;\n    #layer: ImageLayer<ImageSource>;\n    #source: ImageWMS;\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    #capabilities: Record<string, any> | undefined;\n    readonly #abortController = new AbortController();\n\n    constructor(config: WMSLayerConfig) {\n        const layer = new ImageLayer();\n        super({\n            ...config,\n            olLayer: layer\n        });\n        const source = new ImageWMS({\n            ...config.sourceOptions,\n            url: config.url,\n            params: {\n                ...config.sourceOptions?.params\n            },\n            // Use http service to load tiles; needed for authentication etc.\n            imageLoadFunction: (wrapper, url) => {\n                return this.#loadImage(wrapper, url).catch((error) => {\n                    LOG.error(`Failed to load tile at '${url}'`, error);\n                });\n            }\n        });\n        this.#url = config.url;\n        this.#source = source;\n        this.#layer = layer;\n        this.#sublayers = new SublayersCollectionImpl(constructSublayers(config.sublayers));\n        this.#updateLayersParam();\n    }\n\n    get legend() {\n        return undefined;\n    }\n\n    get url(): string {\n        return this.#url;\n    }\n    get __source() {\n        return this.#source;\n    }\n\n    get sublayers(): SublayersCollectionImpl<WMSSublayerImpl> {\n        return this.#sublayers;\n    }\n\n    get capabilities() {\n        return this.#capabilities;\n    }\n\n    __attach(map: MapModelImpl): void {\n        super.__attach(map);\n        for (const sublayer of this.#sublayers.getSublayers()) {\n            sublayer.__attach(map, this, this);\n        }\n        const layers: WMSSublayerImpl[] = [];\n        /** identify all leaf nodes representing a layer in the structure */\n        const getNestedSublayer = (sublayers: WMSSublayerImpl[], layers: WMSSublayerImpl[]) => {\n            for (const sublayer of sublayers) {\n                const nested = sublayer.sublayers.getSublayers();\n                if (nested.length) {\n                    getNestedSublayer(nested, layers);\n                } else {\n                    if (sublayer.name) {\n                        layers.push(sublayer);\n                    }\n                }\n            }\n        };\n        this.#fetchWMSCapabilities()\n            .then((result: string) => {\n                const parser = new WMSCapabilities();\n                const capabilities = parser.read(result);\n                this.#capabilities = capabilities;\n                getNestedSublayer(this.#sublayers.getSublayers(), layers);\n\n                for (const layer of layers) {\n                    const legendUrl = getWMSLegendUrl(capabilities, layer.name!);\n                    layer.legend = legendUrl;\n                }\n            })\n            .catch((error) => {\n                if (isAbortError(error)) {\n                    LOG.error(`Layer ${this.id} has been destroyed before fetching the data`);\n                    return;\n                }\n                LOG.error(`Failed fetching WMS capabilities for Layer ${this.id}`, error);\n            });\n    }\n\n    /** Called by the sublayers when their visibility changed. */\n    __updateSublayerVisibility() {\n        if (this.#deferredSublayerUpdate?.reschedule()) {\n            return;\n        }\n        this.#deferredSublayerUpdate = defer(() => {\n            try {\n                this.#updateLayersParam();\n                this.#deferredSublayerUpdate = undefined;\n            } catch (e) {\n                LOG.error(`Failed to update sublayer visibility on WMS layer '${this.id}'.`, e);\n            }\n        });\n    }\n\n    /**\n     * Gathers the visibility of _all_ sublayers and assembles the 'layers' WMS parameter.\n     * The parameters are then applied to the WMS source.\n     */\n    #updateLayersParam() {\n        const layers = this.#getVisibleLayerNames();\n        this.#source.updateParams({\n            \"LAYERS\": layers\n        });\n\n        // only set source if there are visible sublayers, otherwise\n        // we send an invalid http request\n        const source = layers.length === 0 ? null : this.#source;\n        if (this.#layer.getSource() !== source) {\n            this.#layer.setSource(source);\n        }\n    }\n\n    #getVisibleLayerNames() {\n        const layers: string[] = [];\n        const visitSublayer = (sublayer: WMSSublayerImpl) => {\n            if (!sublayer.visible) {\n                return;\n            }\n\n            const nestedSublayers = sublayer.sublayers.__getRawSublayers();\n            if (nestedSublayers.length) {\n                for (const nestedSublayer of nestedSublayers) {\n                    visitSublayer(nestedSublayer);\n                }\n            } else {\n                /**\n                 * Push sublayer only, if layer name is not an empty string | undefined | ...\n                 */\n                if (sublayer.name) {\n                    layers.push(sublayer.name);\n                }\n            }\n        };\n\n        for (const sublayer of this.sublayers.__getRawSublayers()) {\n            visitSublayer(sublayer);\n        }\n        return layers;\n    }\n\n    async #fetchWMSCapabilities(): Promise<string> {\n        const httpService = this.map.__sharedDependencies.httpService;\n        const url = `${this.#url}?LANGUAGE=ger&SERVICE=WMS&REQUEST=GetCapabilities`;\n        return fetchCapabilities(url, httpService, this.#abortController.signal);\n    }\n\n    async #loadImage(imageWrapper: ImageWrapper, imageUrl: string): Promise<void> {\n        const httpService = this.map.__sharedDependencies.httpService;\n        const image = imageWrapper.getImage() as HTMLImageElement;\n\n        const response = await httpService.fetch(imageUrl);\n        if (!response.ok) {\n            throw new Error(`Request failed with status ${response.status}.`);\n        }\n\n        const blob = await response.blob();\n        const objectUrl = URL.createObjectURL(blob);\n        const finish = () => {\n            // Cleanup object URL after load to prevent memory leaks.\n            // https://stackoverflow.com/questions/62473876/openlayers-6-settileloadfunction-documented-example-uses-url-createobjecturld\n            URL.revokeObjectURL(objectUrl);\n            image.removeEventListener(\"load\", finish);\n            image.removeEventListener(\"error\", finish);\n        };\n\n        image.addEventListener(\"load\", finish);\n        image.addEventListener(\"error\", finish);\n        image.src = objectUrl;\n    }\n}\n\nclass WMSSublayerImpl extends AbstractLayerBase implements WMSSublayer {\n    #parent: WMSSublayerImpl | WMSLayerImpl | undefined;\n    #parentLayer: WMSLayerImpl | undefined;\n    #name: string | undefined;\n    #legend: string | undefined;\n    #sublayers: SublayersCollectionImpl<WMSSublayerImpl>;\n    #visible: boolean;\n\n    constructor(config: WMSSublayerConfig) {\n        super(config);\n        this.#name = config.name;\n        this.#visible = config.visible ?? true;\n        this.#sublayers = new SublayersCollectionImpl(constructSublayers(config.sublayers));\n    }\n\n    get name(): string | undefined {\n        return this.#name;\n    }\n\n    get sublayers(): SublayersCollectionImpl<WMSSublayerImpl> {\n        return this.#sublayers;\n    }\n\n    get parent(): WMSSublayerImpl | WMSLayerImpl {\n        const parent = this.#parent;\n        if (!parent) {\n            throw new Error(`WMS sublayer ${this.id} has not been attached to its parent yet.`);\n        }\n        return parent;\n    }\n\n    get parentLayer(): WMSLayerImpl {\n        const parentLayer = this.#parentLayer;\n        if (!parentLayer) {\n            throw new Error(`WMS sublayer ${this.id} has not been attached to its parent yet.`);\n        }\n        return parentLayer;\n    }\n    get legend(): string | undefined {\n        return this.#legend;\n    }\n\n    set legend(legendUrl: string | undefined) {\n        this.#legend = legendUrl;\n        this.__emitChangeEvent(\"changed:legend\");\n    }\n\n    /**\n     * Called by the parent layer when it is attached to the map to attach all sublayers.\n     */\n    __attach(\n        map: MapModelImpl,\n        parentLayer: WMSLayerImpl,\n        parent: WMSLayerImpl | WMSSublayerImpl\n    ): void {\n        super.__attachToMap(map);\n        if (this.#parent) {\n            throw new Error(\n                `WMS sublayer '${this.id}' has already been attached to parent '${this.#parent.id}'`\n            );\n        }\n        this.#parent = parent;\n        if (this.#parentLayer) {\n            throw new Error(\n                `WMS sublayer '${this.id}' has already been attached to parent layer '${this.#parentLayer.id}'`\n            );\n        }\n        this.#parentLayer = parentLayer;\n\n        // Recurse into nested sublayers\n        for (const sublayer of this.sublayers.__getRawSublayers()) {\n            sublayer.__attach(map, parentLayer, this);\n        }\n    }\n\n    get visible(): boolean {\n        return this.#visible;\n    }\n\n    setVisible(newVisibility: boolean): void {\n        if (this.visible !== newVisibility) {\n            this.#visible = newVisibility;\n            this.#parentLayer?.__updateSublayerVisibility();\n            this.__emitChangeEvent(\"changed:visible\");\n        }\n    }\n}\n\nfunction constructSublayers(sublayerConfigs: WMSSublayerConfig[] = []): WMSSublayerImpl[] {\n    const sublayers: WMSSublayerImpl[] = [];\n    try {\n        for (const sublayerConfig of sublayerConfigs) {\n            sublayers.push(new WMSSublayerImpl(sublayerConfig));\n        }\n        return sublayers;\n    } catch (e) {\n        // Ensure previous sublayers are destroyed if a single constructor throws\n        while (sublayers.length) {\n            const layer = sublayers.pop()!;\n            layer?.destroy();\n        }\n        throw new Error(\"Failed to construct sublayers.\", { cause: e });\n    }\n}\n\n/** extract the legend url from the service capabilities */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport function getWMSLegendUrl(capabilities: Record<string, any>, layerName: string) {\n    const capabilitiesContent = capabilities?.Capability;\n    const rootLayerCapabilities = capabilitiesContent?.Layer;\n    let url: string | undefined = undefined;\n\n    /** Recurse search for the currrent layer within the parsed capabilities service*/\n    //eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const searchNestedLayer = (layer: Record<string, any>[]) => {\n        for (const currentLayer of layer) {\n            // spec. if, a layer has a <Name>, then it is a map layer\n            if (currentLayer?.Name === layerName) {\n                const activeLayer = currentLayer;\n                const styles = activeLayer.Style;\n                if (!styles || !styles.length) {\n                    LOG.debug(\"No style in WMS layer capabilities - giving up.\");\n                    return;\n                }\n                // by parsing of the service capabilities, every child inherits the parent's legend\n                // theorfore, extract the legendURL from the first style object in the array (its own legend)\n                const activeStyle = styles[0];\n                url = activeStyle.LegendURL?.[0]?.OnlineResource;\n            } else if (currentLayer.Layer) {\n                searchNestedLayer(currentLayer.Layer);\n            }\n        }\n    };\n    if (rootLayerCapabilities) {\n        searchNestedLayer(rootLayerCapabilities.Layer);\n    }\n    return url;\n}\n"],"names":["layers"],"mappings":";;;;;;;;;;AAgBA,MAAM,GAAA,GAAM,aAAa,cAAc,CAAA;AAEhC,MAAM,qBAAqB,aAAA,CAAkC;AAAA,EAChE,IAAA;AAAA,EACA,UAAA;AAAA,EACA,uBAAA;AAAA,EACA,MAAA;AAAA,EACA,OAAA;AAAA;AAAA,EAEA,aAAA;AAAA,EACS,gBAAA,GAAmB,IAAI,eAAA,EAAgB;AAAA,EAEhD,YAAY,MAAA,EAAwB;AAChC,IAAA,MAAM,KAAA,GAAQ,IAAI,UAAA,EAAW;AAC7B,IAAA,KAAA,CAAM;AAAA,MACF,GAAG,MAAA;AAAA,MACH,OAAA,EAAS;AAAA,KACZ,CAAA;AACD,IAAA,MAAM,MAAA,GAAS,IAAI,QAAA,CAAS;AAAA,MACxB,GAAG,MAAA,CAAO,aAAA;AAAA,MACV,KAAK,MAAA,CAAO,GAAA;AAAA,MACZ,MAAA,EAAQ;AAAA,QACJ,GAAG,OAAO,aAAA,EAAe;AAAA,OAC7B;AAAA;AAAA,MAEA,iBAAA,EAAmB,CAAC,OAAA,EAAS,GAAA,KAAQ;AACjC,QAAA,OAAO,KAAK,UAAA,CAAW,OAAA,EAAS,GAAG,CAAA,CAAE,KAAA,CAAM,CAAC,KAAA,KAAU;AAClD,UAAA,GAAA,CAAI,KAAA,CAAM,CAAA,wBAAA,EAA2B,GAAG,CAAA,CAAA,CAAA,EAAK,KAAK,CAAA;AAAA,QACtD,CAAC,CAAA;AAAA,MACL;AAAA,KACH,CAAA;AACD,IAAA,IAAA,CAAK,OAAO,MAAA,CAAO,GAAA;AACnB,IAAA,IAAA,CAAK,OAAA,GAAU,MAAA;AACf,IAAA,IAAA,CAAK,MAAA,GAAS,KAAA;AACd,IAAA,IAAA,CAAK,aAAa,IAAI,uBAAA,CAAwB,kBAAA,CAAmB,MAAA,CAAO,SAAS,CAAC,CAAA;AAClF,IAAA,IAAA,CAAK,kBAAA,EAAmB;AAAA,EAC5B;AAAA,EAEA,IAAI,MAAA,GAAS;AACT,IAAA,OAAO,MAAA;AAAA,EACX;AAAA,EAEA,IAAI,GAAA,GAAc;AACd,IAAA,OAAO,IAAA,CAAK,IAAA;AAAA,EAChB;AAAA,EACA,IAAI,QAAA,GAAW;AACX,IAAA,OAAO,IAAA,CAAK,OAAA;AAAA,EAChB;AAAA,EAEA,IAAI,SAAA,GAAsD;AACtD,IAAA,OAAO,IAAA,CAAK,UAAA;AAAA,EAChB;AAAA,EAEA,IAAI,YAAA,GAAe;AACf,IAAA,OAAO,IAAA,CAAK,aAAA;AAAA,EAChB;AAAA,EAEA,SAAS,GAAA,EAAyB;AAC9B,IAAA,KAAA,CAAM,SAAS,GAAG,CAAA;AAClB,IAAA,KAAA,MAAW,QAAA,IAAY,IAAA,CAAK,UAAA,CAAW,YAAA,EAAa,EAAG;AACnD,MAAA,QAAA,CAAS,QAAA,CAAS,GAAA,EAAK,IAAA,EAAM,IAAI,CAAA;AAAA,IACrC;AACA,IAAA,MAAM,SAA4B,EAAC;AAEnC,IAAA,MAAM,iBAAA,GAAoB,CAAC,SAAA,EAA8BA,OAAAA,KAA8B;AACnF,MAAA,KAAA,MAAW,YAAY,SAAA,EAAW;AAC9B,QAAA,MAAM,MAAA,GAAS,QAAA,CAAS,SAAA,CAAU,YAAA,EAAa;AAC/C,QAAA,IAAI,OAAO,MAAA,EAAQ;AACf,UAAA,iBAAA,CAAkB,QAAQA,OAAM,CAAA;AAAA,QACpC,CAAA,MAAO;AACH,UAAA,IAAI,SAAS,IAAA,EAAM;AACf,YAAAA,OAAAA,CAAO,KAAK,QAAQ,CAAA;AAAA,UACxB;AAAA,QACJ;AAAA,MACJ;AAAA,IACJ,CAAA;AACA,IAAA,IAAA,CAAK,qBAAA,EAAsB,CACtB,IAAA,CAAK,CAAC,MAAA,KAAmB;AACtB,MAAA,MAAM,MAAA,GAAS,IAAI,eAAA,EAAgB;AACnC,MAAA,MAAM,YAAA,GAAe,MAAA,CAAO,IAAA,CAAK,MAAM,CAAA;AACvC,MAAA,IAAA,CAAK,aAAA,GAAgB,YAAA;AACrB,MAAA,iBAAA,CAAkB,IAAA,CAAK,UAAA,CAAW,YAAA,EAAa,EAAG,MAAM,CAAA;AAExD,MAAA,KAAA,MAAW,SAAS,MAAA,EAAQ;AACxB,QAAA,MAAM,SAAA,GAAY,eAAA,CAAgB,YAAA,EAAc,KAAA,CAAM,IAAK,CAAA;AAC3D,QAAA,KAAA,CAAM,MAAA,GAAS,SAAA;AAAA,MACnB;AAAA,IACJ,CAAC,CAAA,CACA,KAAA,CAAM,CAAC,KAAA,KAAU;AACd,MAAA,IAAI,YAAA,CAAa,KAAK,CAAA,EAAG;AACrB,QAAA,GAAA,CAAI,KAAA,CAAM,CAAA,MAAA,EAAS,IAAA,CAAK,EAAE,CAAA,4CAAA,CAA8C,CAAA;AACxE,QAAA;AAAA,MACJ;AACA,MAAA,GAAA,CAAI,KAAA,CAAM,CAAA,2CAAA,EAA8C,IAAA,CAAK,EAAE,IAAI,KAAK,CAAA;AAAA,IAC5E,CAAC,CAAA;AAAA,EACT;AAAA;AAAA,EAGA,0BAAA,GAA6B;AACzB,IAAA,IAAI,IAAA,CAAK,uBAAA,EAAyB,UAAA,EAAW,EAAG;AAC5C,MAAA;AAAA,IACJ;AACA,IAAA,IAAA,CAAK,uBAAA,GAA0B,MAAM,MAAM;AACvC,MAAA,IAAI;AACA,QAAA,IAAA,CAAK,kBAAA,EAAmB;AACxB,QAAA,IAAA,CAAK,uBAAA,GAA0B,KAAA,CAAA;AAAA,MACnC,SAAS,CAAA,EAAG;AACR,QAAA,GAAA,CAAI,KAAA,CAAM,CAAA,mDAAA,EAAsD,IAAA,CAAK,EAAE,MAAM,CAAC,CAAA;AAAA,MAClF;AAAA,IACJ,CAAC,CAAA;AAAA,EACL;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,kBAAA,GAAqB;AACjB,IAAA,MAAM,MAAA,GAAS,KAAK,qBAAA,EAAsB;AAC1C,IAAA,IAAA,CAAK,QAAQ,YAAA,CAAa;AAAA,MACtB,QAAA,EAAU;AAAA,KACb,CAAA;AAID,IAAA,MAAM,MAAA,GAAS,MAAA,CAAO,MAAA,KAAW,CAAA,GAAI,OAAO,IAAA,CAAK,OAAA;AACjD,IAAA,IAAI,IAAA,CAAK,MAAA,CAAO,SAAA,EAAU,KAAM,MAAA,EAAQ;AACpC,MAAA,IAAA,CAAK,MAAA,CAAO,UAAU,MAAM,CAAA;AAAA,IAChC;AAAA,EACJ;AAAA,EAEA,qBAAA,GAAwB;AACpB,IAAA,MAAM,SAAmB,EAAC;AAC1B,IAAA,MAAM,aAAA,GAAgB,CAAC,QAAA,KAA8B;AACjD,MAAA,IAAI,CAAC,SAAS,OAAA,EAAS;AACnB,QAAA;AAAA,MACJ;AAEA,MAAA,MAAM,eAAA,GAAkB,QAAA,CAAS,SAAA,CAAU,iBAAA,EAAkB;AAC7D,MAAA,IAAI,gBAAgB,MAAA,EAAQ;AACxB,QAAA,KAAA,MAAW,kBAAkB,eAAA,EAAiB;AAC1C,UAAA,aAAA,CAAc,cAAc,CAAA;AAAA,QAChC;AAAA,MACJ,CAAA,MAAO;AAIH,QAAA,IAAI,SAAS,IAAA,EAAM;AACf,UAAA,MAAA,CAAO,IAAA,CAAK,SAAS,IAAI,CAAA;AAAA,QAC7B;AAAA,MACJ;AAAA,IACJ,CAAA;AAEA,IAAA,KAAA,MAAW,QAAA,IAAY,IAAA,CAAK,SAAA,CAAU,iBAAA,EAAkB,EAAG;AACvD,MAAA,aAAA,CAAc,QAAQ,CAAA;AAAA,IAC1B;AACA,IAAA,OAAO,MAAA;AAAA,EACX;AAAA,EAEA,MAAM,qBAAA,GAAyC;AAC3C,IAAA,MAAM,WAAA,GAAc,IAAA,CAAK,GAAA,CAAI,oBAAA,CAAqB,WAAA;AAClD,IAAA,MAAM,GAAA,GAAM,CAAA,EAAG,IAAA,CAAK,IAAI,CAAA,iDAAA,CAAA;AACxB,IAAA,OAAO,iBAAA,CAAkB,GAAA,EAAK,WAAA,EAAa,IAAA,CAAK,iBAAiB,MAAM,CAAA;AAAA,EAC3E;AAAA,EAEA,MAAM,UAAA,CAAW,YAAA,EAA4B,QAAA,EAAiC;AAC1E,IAAA,MAAM,WAAA,GAAc,IAAA,CAAK,GAAA,CAAI,oBAAA,CAAqB,WAAA;AAClD,IAAA,MAAM,KAAA,GAAQ,aAAa,QAAA,EAAS;AAEpC,IAAA,MAAM,QAAA,GAAW,MAAM,WAAA,CAAY,KAAA,CAAM,QAAQ,CAAA;AACjD,IAAA,IAAI,CAAC,SAAS,EAAA,EAAI;AACd,MAAA,MAAM,IAAI,KAAA,CAAM,CAAA,2BAAA,EAA8B,QAAA,CAAS,MAAM,CAAA,CAAA,CAAG,CAAA;AAAA,IACpE;AAEA,IAAA,MAAM,IAAA,GAAO,MAAM,QAAA,CAAS,IAAA,EAAK;AACjC,IAAA,MAAM,SAAA,GAAY,GAAA,CAAI,eAAA,CAAgB,IAAI,CAAA;AAC1C,IAAA,MAAM,SAAS,MAAM;AAGjB,MAAA,GAAA,CAAI,gBAAgB,SAAS,CAAA;AAC7B,MAAA,KAAA,CAAM,mBAAA,CAAoB,QAAQ,MAAM,CAAA;AACxC,MAAA,KAAA,CAAM,mBAAA,CAAoB,SAAS,MAAM,CAAA;AAAA,IAC7C,CAAA;AAEA,IAAA,KAAA,CAAM,gBAAA,CAAiB,QAAQ,MAAM,CAAA;AACrC,IAAA,KAAA,CAAM,gBAAA,CAAiB,SAAS,MAAM,CAAA;AACtC,IAAA,KAAA,CAAM,GAAA,GAAM,SAAA;AAAA,EAChB;AACJ;AAEA,MAAM,wBAAwB,iBAAA,CAAyC;AAAA,EACnE,OAAA;AAAA,EACA,YAAA;AAAA,EACA,KAAA;AAAA,EACA,OAAA;AAAA,EACA,UAAA;AAAA,EACA,QAAA;AAAA,EAEA,YAAY,MAAA,EAA2B;AACnC,IAAA,KAAA,CAAM,MAAM,CAAA;AACZ,IAAA,IAAA,CAAK,QAAQ,MAAA,CAAO,IAAA;AACpB,IAAA,IAAA,CAAK,QAAA,GAAW,OAAO,OAAA,IAAW,IAAA;AAClC,IAAA,IAAA,CAAK,aAAa,IAAI,uBAAA,CAAwB,kBAAA,CAAmB,MAAA,CAAO,SAAS,CAAC,CAAA;AAAA,EACtF;AAAA,EAEA,IAAI,IAAA,GAA2B;AAC3B,IAAA,OAAO,IAAA,CAAK,KAAA;AAAA,EAChB;AAAA,EAEA,IAAI,SAAA,GAAsD;AACtD,IAAA,OAAO,IAAA,CAAK,UAAA;AAAA,EAChB;AAAA,EAEA,IAAI,MAAA,GAAyC;AACzC,IAAA,MAAM,SAAS,IAAA,CAAK,OAAA;AACpB,IAAA,IAAI,CAAC,MAAA,EAAQ;AACT,MAAA,MAAM,IAAI,KAAA,CAAM,CAAA,aAAA,EAAgB,IAAA,CAAK,EAAE,CAAA,yCAAA,CAA2C,CAAA;AAAA,IACtF;AACA,IAAA,OAAO,MAAA;AAAA,EACX;AAAA,EAEA,IAAI,WAAA,GAA4B;AAC5B,IAAA,MAAM,cAAc,IAAA,CAAK,YAAA;AACzB,IAAA,IAAI,CAAC,WAAA,EAAa;AACd,MAAA,MAAM,IAAI,KAAA,CAAM,CAAA,aAAA,EAAgB,IAAA,CAAK,EAAE,CAAA,yCAAA,CAA2C,CAAA;AAAA,IACtF;AACA,IAAA,OAAO,WAAA;AAAA,EACX;AAAA,EACA,IAAI,MAAA,GAA6B;AAC7B,IAAA,OAAO,IAAA,CAAK,OAAA;AAAA,EAChB;AAAA,EAEA,IAAI,OAAO,SAAA,EAA+B;AACtC,IAAA,IAAA,CAAK,OAAA,GAAU,SAAA;AACf,IAAA,IAAA,CAAK,kBAAkB,gBAAgB,CAAA;AAAA,EAC3C;AAAA;AAAA;AAAA;AAAA,EAKA,QAAA,CACI,GAAA,EACA,WAAA,EACA,MAAA,EACI;AACJ,IAAA,KAAA,CAAM,cAAc,GAAG,CAAA;AACvB,IAAA,IAAI,KAAK,OAAA,EAAS;AACd,MAAA,MAAM,IAAI,KAAA;AAAA,QACN,iBAAiB,IAAA,CAAK,EAAE,CAAA,uCAAA,EAA0C,IAAA,CAAK,QAAQ,EAAE,CAAA,CAAA;AAAA,OACrF;AAAA,IACJ;AACA,IAAA,IAAA,CAAK,OAAA,GAAU,MAAA;AACf,IAAA,IAAI,KAAK,YAAA,EAAc;AACnB,MAAA,MAAM,IAAI,KAAA;AAAA,QACN,iBAAiB,IAAA,CAAK,EAAE,CAAA,6CAAA,EAAgD,IAAA,CAAK,aAAa,EAAE,CAAA,CAAA;AAAA,OAChG;AAAA,IACJ;AACA,IAAA,IAAA,CAAK,YAAA,GAAe,WAAA;AAGpB,IAAA,KAAA,MAAW,QAAA,IAAY,IAAA,CAAK,SAAA,CAAU,iBAAA,EAAkB,EAAG;AACvD,MAAA,QAAA,CAAS,QAAA,CAAS,GAAA,EAAK,WAAA,EAAa,IAAI,CAAA;AAAA,IAC5C;AAAA,EACJ;AAAA,EAEA,IAAI,OAAA,GAAmB;AACnB,IAAA,OAAO,IAAA,CAAK,QAAA;AAAA,EAChB;AAAA,EAEA,WAAW,aAAA,EAA8B;AACrC,IAAA,IAAI,IAAA,CAAK,YAAY,aAAA,EAAe;AAChC,MAAA,IAAA,CAAK,QAAA,GAAW,aAAA;AAChB,MAAA,IAAA,CAAK,cAAc,0BAAA,EAA2B;AAC9C,MAAA,IAAA,CAAK,kBAAkB,iBAAiB,CAAA;AAAA,IAC5C;AAAA,EACJ;AACJ;AAEA,SAAS,kBAAA,CAAmB,eAAA,GAAuC,EAAC,EAAsB;AACtF,EAAA,MAAM,YAA+B,EAAC;AACtC,EAAA,IAAI;AACA,IAAA,KAAA,MAAW,kBAAkB,eAAA,EAAiB;AAC1C,MAAA,SAAA,CAAU,IAAA,CAAK,IAAI,eAAA,CAAgB,cAAc,CAAC,CAAA;AAAA,IACtD;AACA,IAAA,OAAO,SAAA;AAAA,EACX,SAAS,CAAA,EAAG;AAER,IAAA,OAAO,UAAU,MAAA,EAAQ;AACrB,MAAA,MAAM,KAAA,GAAQ,UAAU,GAAA,EAAI;AAC5B,MAAA,KAAA,EAAO,OAAA,EAAQ;AAAA,IACnB;AACA,IAAA,MAAM,IAAI,KAAA,CAAM,gCAAA,EAAkC,EAAE,KAAA,EAAO,GAAG,CAAA;AAAA,EAClE;AACJ;AAIO,SAAS,eAAA,CAAgB,cAAmC,SAAA,EAAmB;AAClF,EAAA,MAAM,sBAAsB,YAAA,EAAc,UAAA;AAC1C,EAAA,MAAM,wBAAwB,mBAAA,EAAqB,KAAA;AACnD,EAAA,IAAI,GAAA,GAA0B,MAAA;AAI9B,EAAA,MAAM,iBAAA,GAAoB,CAAC,KAAA,KAAiC;AACxD,IAAA,KAAA,MAAW,gBAAgB,KAAA,EAAO;AAE9B,MAAA,IAAI,YAAA,EAAc,SAAS,SAAA,EAAW;AAClC,QAAA,MAAM,WAAA,GAAc,YAAA;AACpB,QAAA,MAAM,SAAS,WAAA,CAAY,KAAA;AAC3B,QAAA,IAAI,CAAC,MAAA,IAAU,CAAC,MAAA,CAAO,MAAA,EAAQ;AAC3B,UAAA,GAAA,CAAI,MAAM,iDAAiD,CAAA;AAC3D,UAAA;AAAA,QACJ;AAGA,QAAA,MAAM,WAAA,GAAc,OAAO,CAAC,CAAA;AAC5B,QAAA,GAAA,GAAM,WAAA,CAAY,SAAA,GAAY,CAAC,CAAA,EAAG,cAAA;AAAA,MACtC,CAAA,MAAA,IAAW,aAAa,KAAA,EAAO;AAC3B,QAAA,iBAAA,CAAkB,aAAa,KAAK,CAAA;AAAA,MACxC;AAAA,IACJ;AAAA,EACJ,CAAA;AACA,EAAA,IAAI,qBAAA,EAAuB;AACvB,IAAA,iBAAA,CAAkB,sBAAsB,KAAK,CAAA;AAAA,EACjD;AACA,EAAA,OAAO,GAAA;AACX;;;;"}