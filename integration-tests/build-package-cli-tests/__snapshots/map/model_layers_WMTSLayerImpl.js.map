{"version":3,"file":"WMTSLayerImpl.js","sources":["WMTSLayerImpl.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2023 Open Pioneer project (https://github.com/open-pioneer)\n// SPDX-License-Identifier: Apache-2.0\nimport { createLogger, isAbortError } from \"@open-pioneer/core\";\nimport Tile from \"ol/Tile\";\nimport TileState from \"ol/TileState\";\nimport WMTSCapabilities from \"ol/format/WMTSCapabilities\";\nimport TileLayer from \"ol/layer/Tile\";\nimport type TileSourceType from \"ol/source/Tile\";\nimport WMTS, { optionsFromCapabilities } from \"ol/source/WMTS\";\nimport { WMTSLayer, WMTSLayerConfig } from \"../../api\";\nimport { fetchCapabilities } from \"../../util/capabilities-utils\";\nimport { AbstractLayer } from \"../AbstractLayer\";\nimport { MapModelImpl } from \"../MapModelImpl\";\nimport { ImageTile } from \"ol\";\nimport type { Options as WMSSourceOptions } from \"ol/source/ImageWMS\";\n\nconst LOG = createLogger(\"map:WMTSLayer\");\n\nexport class WMTSLayerImpl extends AbstractLayer implements WMTSLayer {\n    #url: string;\n    #name: string;\n    #matrixSet: string;\n    #layer: TileLayer<TileSourceType>;\n    #source: WMTS | undefined;\n    #legend: string | undefined;\n    #sourceOptions?: Partial<WMSSourceOptions>;\n    readonly #abortController = new AbortController();\n\n    constructor(config: WMTSLayerConfig) {\n        const layer = new TileLayer();\n        super({\n            ...config,\n            olLayer: layer\n        });\n        this.#url = config.url;\n        this.#name = config.name;\n        this.#layer = layer;\n        this.#matrixSet = config.matrixSet;\n        this.#sourceOptions = config.sourceOptions;\n    }\n\n    destroy(): void {\n        super.destroy();\n        this.#abortController.abort();\n    }\n\n    get legend(): string | undefined {\n        return this.#legend;\n    }\n\n    __attach(map: MapModelImpl): void {\n        super.__attach(map);\n        this.#fetchWMTSCapabilities()\n            .then((result: string) => {\n                const parser = new WMTSCapabilities();\n                const capabilities = parser.read(result);\n                const options = optionsFromCapabilities(capabilities, {\n                    layer: this.#name,\n                    matrixSet: this.#matrixSet\n                });\n                if (!options) {\n                    throw new Error(\"Layer was not found in capabilities\");\n                }\n                const source = new WMTS({\n                    ...options,\n                    ...this.#sourceOptions,\n                    tileLoadFunction: (tile, tileUrl) => {\n                        this.#loadTile(tile, tileUrl);\n                    }\n                });\n                this.#source = source;\n                this.#layer.setSource(this.#source);\n                const activeStyleId = source.getStyle();\n                const legendUrl = getWMTSLegendUrl(capabilities, this.name, activeStyleId);\n                this.#legend = legendUrl;\n                this.__emitChangeEvent(\"changed:legend\");\n            })\n            .catch((error) => {\n                if (isAbortError(error)) {\n                    LOG.error(`Layer ${this.name} has been destroyed before fetching the data`);\n                    return;\n                }\n                LOG.error(`Failed fetching WMTS capabilities for Layer ${this.name}`, error);\n            });\n    }\n\n    get layer() {\n        return this.#layer;\n    }\n\n    get url() {\n        return this.#url;\n    }\n\n    get name() {\n        return this.#name;\n    }\n\n    get matrixSet() {\n        return this.#matrixSet;\n    }\n\n    get sublayers(): undefined {\n        return undefined;\n    }\n\n    async #fetchWMTSCapabilities(): Promise<string> {\n        const httpService = this.map.__sharedDependencies.httpService;\n        return fetchCapabilities(this.#url, httpService, this.#abortController.signal);\n    }\n\n    async #loadTile(tile: Tile, tileUrl: string): Promise<void> {\n        const httpService = this.map.__sharedDependencies.httpService;\n        try {\n            if (!(tile instanceof ImageTile)) {\n                throw new Error(\"Only 'ImageTile' is supported for now.\");\n            }\n\n            const image = tile.getImage();\n            if (!isHtmlImage(image)) {\n                // Could also be canvas or video\n                throw new Error(\"Only <img> tags are supported as tiles for now.\");\n            }\n\n            const response = await httpService.fetch(tileUrl);\n            if (!response.ok) {\n                throw new Error(`Tile request failed with status ${response.status}.`);\n            }\n\n            const blob = await response.blob();\n            const objectUrl = URL.createObjectURL(blob);\n            const finish = () => {\n                // Cleanup object URL after load to prevent memory leaks.\n                // https://stackoverflow.com/questions/62473876/openlayers-6-settileloadfunction-documented-example-uses-url-createobjecturld\n                URL.revokeObjectURL(objectUrl);\n                image.removeEventListener(\"load\", finish);\n                image.removeEventListener(\"error\", finish);\n            };\n            image.addEventListener(\"load\", finish);\n            image.addEventListener(\"error\", finish);\n            image.src = objectUrl;\n        } catch (e) {\n            tile.setState(TileState.ERROR);\n            if (!isAbortError(e)) {\n                LOG.error(\"Failed to load tile\", e);\n            }\n        }\n    }\n}\n\nfunction isHtmlImage(htmlElement: HTMLElement): htmlElement is HTMLImageElement {\n    return htmlElement.tagName === \"IMG\";\n}\n/* eslint-disable @typescript-eslint/no-explicit-any */\nexport function getWMTSLegendUrl(\n    capabilities: Record<string, any>,\n    activeLayerId: string | undefined,\n    activeStyleId: string | undefined\n): string | undefined {\n    const content = capabilities?.Contents;\n    const layers = content?.Layer;\n\n    let activeLayer = layers?.find((layer: any) => layer?.Identifier === activeLayerId);\n    if (!activeLayer) {\n        LOG.debug(\"Failed to find the active layer in WMTS layer capabilities.\");\n        activeLayer = layers?.[0];\n        if (!activeLayer) {\n            LOG.debug(\"No layer in WMTS capabilities - giving up.\");\n            return undefined;\n        }\n    }\n\n    const styles = activeLayer.Style;\n    let activeStyle = styles?.find((style: any) => style?.Identifier === activeStyleId);\n    if (!activeStyle) {\n        LOG.debug(\"Failed to find active style in WMTS layer.\");\n        activeStyle = styles?.[0];\n        if (!activeStyle) {\n            LOG.debug(\"No style in WMTS layer capabilities - giving up.\");\n            return undefined;\n        }\n    }\n\n    const legendUrl = activeStyle.LegendURL?.[0]?.href;\n    return legendUrl as string | undefined;\n}\n"],"names":[],"mappings":"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"}