{"version":3,"file":"AbstractLayer.js","sources":["AbstractLayer.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2023 Open Pioneer project (https://github.com/open-pioneer)\n// SPDX-License-Identifier: Apache-2.0\nimport { Resource, createLogger } from \"@open-pioneer/core\";\nimport { unByKey } from \"ol/Observable\";\nimport { EventsKey } from \"ol/events\";\nimport OlBaseLayer from \"ol/layer/Base\";\nimport OlLayer from \"ol/layer/Layer\";\nimport OlSource from \"ol/source/Source\";\nimport { HealthCheckFunction, Layer, LayerConfig, LayerLoadState, SimpleLayerConfig } from \"../api\";\nimport { AbstractLayerBase } from \"./AbstractLayerBase\";\nimport { MapModelImpl } from \"./MapModelImpl\";\n\nconst LOG = createLogger(\"map:AbstractLayer\");\n\n/**\n * Base class for normal layer types.\n *\n * These layers always have an associated OpenLayers layer.\n */\nexport abstract class AbstractLayer<AdditionalEvents = {}>\n    extends AbstractLayerBase<AdditionalEvents>\n    implements Layer\n{\n    #olLayer: OlBaseLayer;\n    #isBaseLayer: boolean;\n    #healthCheck?: string | HealthCheckFunction;\n    #visible: boolean;\n\n    #loadState: LayerLoadState;\n    #stateWatchResource: Resource | undefined;\n\n    constructor(config: SimpleLayerConfig) {\n        super(config);\n        this.#olLayer = config.olLayer;\n        this.#isBaseLayer = config.isBaseLayer ?? false;\n        this.#healthCheck = config.healthCheck;\n\n        this.#visible = config.visible ?? true;\n        this.#loadState = getSourceState(getSource(this.#olLayer));\n    }\n\n    get visible(): boolean {\n        return this.#visible;\n    }\n\n    get olLayer(): OlBaseLayer {\n        return this.#olLayer;\n    }\n\n    get isBaseLayer(): boolean {\n        return this.#isBaseLayer;\n    }\n\n    get loadState(): LayerLoadState {\n        return this.#loadState;\n    }\n\n    destroy() {\n        if (this.__destroyed) {\n            return;\n        }\n\n        this.#stateWatchResource?.destroy();\n        this.olLayer.dispose();\n        super.destroy();\n    }\n\n    /**\n     * Called by the map model when the layer is added to the map.\n     */\n    __attach(map: MapModelImpl): void {\n        super.__attachToMap(map);\n\n        const { initial: initialState, resource: stateWatchResource } = watchLoadState(\n            this,\n            this.#healthCheck,\n            (state) => {\n                this.#setLoadState(state);\n            }\n        );\n        this.#stateWatchResource = stateWatchResource;\n        this.#setLoadState(initialState);\n    }\n\n    setVisible(newVisibility: boolean): void {\n        if (this.isBaseLayer) {\n            LOG.warn(\n                `Cannot change visibility of base layer '${this.id}': use activateBaseLayer() on the map's LayerCollection instead.`\n            );\n            return;\n        }\n\n        this.__setVisible(newVisibility);\n    }\n\n    __setVisible(newVisibility: boolean): void {\n        let changed = false;\n        if (this.#visible !== newVisibility) {\n            this.#visible = newVisibility;\n            changed = true;\n        }\n\n        // Improvement: actual map sync?\n        if (this.#olLayer.getVisible() != this.#visible) {\n            this.#olLayer.setVisible(newVisibility);\n        }\n        changed && this.__emitChangeEvent(\"changed:visible\");\n    }\n\n    #setLoadState(loadState: LayerLoadState) {\n        if (loadState !== this.#loadState) {\n            this.#loadState = loadState;\n            this.__emitChangeEvent(\"changed:loadState\");\n        }\n    }\n}\n\nfunction watchLoadState(\n    layer: AbstractLayer,\n    healthCheck: LayerConfig[\"healthCheck\"],\n    onChange: (newState: LayerLoadState) => void\n): { initial: LayerLoadState; resource: Resource } {\n    const olLayer = layer.olLayer;\n\n    if (!(olLayer instanceof OlLayer)) {\n        // Some layers don't have a source (such as group)\n        return {\n            initial: \"loaded\",\n            resource: {\n                destroy() {\n                    void 0;\n                }\n            }\n        };\n    }\n\n    let currentSource = getSource(olLayer);\n    const currentOlLayerState = getSourceState(currentSource);\n\n    let currentLoadState: LayerLoadState = currentOlLayerState;\n    let currentHealthState = \"loading\"; // initial state loading until health check finished\n\n    // custom health check not needed when OpenLayers already returning an error state\n    if (currentOlLayerState !== \"error\") {\n        // health check only once during initialization\n        doHealthCheck(layer, healthCheck).then((state: LayerLoadState) => {\n            currentHealthState = state;\n            updateState();\n        });\n    }\n\n    const updateState = () => {\n        const olLayerState = getSourceState(currentSource);\n        const nextLoadState: LayerLoadState =\n            currentHealthState === \"error\" ? \"error\" : olLayerState;\n\n        if (currentLoadState !== nextLoadState) {\n            currentLoadState = nextLoadState;\n            onChange(currentLoadState);\n        }\n    };\n\n    let stateHandle: EventsKey | undefined;\n    stateHandle = currentSource?.on(\"change\", () => {\n        updateState();\n    });\n\n    const sourceHandle = olLayer.on(\"change:source\", () => {\n        // unsubscribe from old source\n        stateHandle && unByKey(stateHandle);\n        stateHandle = undefined;\n\n        // subscribe to new source and update state\n        currentSource = getSource(olLayer);\n        stateHandle = currentSource?.on(\"change\", () => {\n            updateState();\n        });\n        updateState();\n    });\n    return {\n        initial: currentLoadState,\n        resource: {\n            destroy() {\n                stateHandle && unByKey(stateHandle);\n                unByKey(sourceHandle);\n            }\n        }\n    };\n}\n\nasync function doHealthCheck(\n    layer: AbstractLayer,\n    healthCheck: LayerConfig[\"healthCheck\"]\n): Promise<LayerLoadState> {\n    if (healthCheck == null) {\n        return \"loaded\";\n    }\n\n    let healthCheckFn: HealthCheckFunction;\n    if (typeof healthCheck === \"function\") {\n        healthCheckFn = healthCheck;\n    } else if (typeof healthCheck === \"string\") {\n        healthCheckFn = async () => {\n            const httpService = layer.map.__sharedDependencies.httpService;\n            const response = await httpService.fetch(healthCheck);\n            if (response.ok) {\n                return \"loaded\";\n            }\n            LOG.warn(\n                `Health check failed for layer '${layer.id}' (http status ${response.status})`\n            );\n            return \"error\";\n        };\n    } else {\n        LOG.error(\n            `Unexpected object for 'healthCheck' parameter of layer '${layer.id}'`,\n            healthCheck\n        );\n        return \"error\";\n    }\n\n    try {\n        return await healthCheckFn(layer);\n    } catch (e) {\n        LOG.warn(`Health check failed for layer '${layer.id}'`, e);\n        return \"error\";\n    }\n}\n\nfunction getSource(olLayer: OlLayer | OlBaseLayer) {\n    if (!(olLayer instanceof OlLayer)) {\n        return undefined;\n    }\n    return (olLayer?.getSource() as OlSource | null) ?? undefined;\n}\n\nfunction getSourceState(olSource: OlSource | undefined) {\n    const state = olSource?.getState();\n    switch (state) {\n        case undefined:\n            return \"loaded\";\n        case \"undefined\":\n            return \"not-loaded\";\n        case \"loading\":\n            return \"loading\";\n        case \"ready\":\n            return \"loaded\";\n        case \"error\":\n            return \"error\";\n    }\n}\n"],"names":[],"mappings":"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"}