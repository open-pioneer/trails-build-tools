{"version":3,"file":"Highlights.js","sources":["Highlights.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2023 Open Pioneer project (https://github.com/open-pioneer)\n// SPDX-License-Identifier: Apache-2.0\n\nimport { Feature } from \"ol\";\nimport OlMap from \"ol/Map\";\nimport { Coordinate } from \"ol/coordinate\";\nimport { Extent, createEmpty, extend, getArea, getCenter } from \"ol/extent\";\nimport { Geometry, LineString, Point, Polygon } from \"ol/geom\";\nimport VectorLayer from \"ol/layer/Vector\";\nimport VectorSource from \"ol/source/Vector\";\nimport { Fill, Icon, Stroke, Style } from \"ol/style\";\nimport { toFunction as toStyleFunction } from \"ol/style/Style\";\nimport { HighlightOptions, HighlightStyle } from \"../api/MapModel\";\nimport mapMarkerUrl from \"../assets/images/mapMarker.png?url\";\nimport { FeatureLike } from \"ol/Feature\";\nimport { TOPMOST_LAYER_Z } from \"./LayerCollectionImpl\";\nimport { Layer as OlLayer } from \"ol/layer\";\nimport { calculateBufferedExtent } from \"../util/geometry-utils\";\n\nconst DEFAULT_OL_POINT_ZOOM_LEVEL = 17;\nconst DEFAULT_OL_MAX_ZOOM_LEVEL = 20;\n\nexport class Highlights {\n    private olMap: OlMap;\n    private currentHighlight: OlLayer | undefined;\n\n    constructor(olMap: OlMap) {\n        this.olMap = olMap;\n    }\n\n    destroy() {\n        this.clearHighlight();\n    }\n\n    /**\n     * This method shows the position of a text search result zoomed to and marked or highlighted in the map.\n     */\n    addHighlightOrMarkerAndZoom(\n        geometries: Point[] | LineString[] | Polygon[],\n        options: HighlightOptions\n    ) {\n        // Cleanup existing highlight\n        this.clearHighlight();\n\n        if (!geometries || !geometries.length) {\n            return;\n        }\n        this.zoomAndAddMarkers(geometries, options);\n    }\n\n    clearHighlight() {\n        if (this.currentHighlight) {\n            this.olMap.removeLayer(this.currentHighlight);\n            this.currentHighlight = undefined;\n        }\n    }\n\n    private zoomAndAddMarkers(geometries: Geometry[], options: HighlightOptions | undefined) {\n        let extent = createEmpty();\n        for (const geom of geometries) {\n            extent = extend(extent, geom.getExtent());\n        }\n\n        const center = getCenter(extent);\n        const isPoint = getArea(extent) === 0;\n        const zoomScale = isPoint\n            ? options?.pointZoom ?? DEFAULT_OL_POINT_ZOOM_LEVEL\n            : options?.maxZoom ?? DEFAULT_OL_MAX_ZOOM_LEVEL;\n        setCenter(this.olMap, center);\n        zoomTo(this.olMap, extent, zoomScale);\n        this.createAndAddLayer(geometries, options?.highlightStyle);\n    }\n\n    private createAndAddLayer(geometries: Geometry[], highlightStyle: HighlightStyle | undefined) {\n        const features = geometries.map((geometry) => {\n            return new Feature({\n                type: geometry.getType(),\n                geometry: geometry\n            });\n        });\n        const layer = new VectorLayer({\n            className: \"highlight-layer\",\n            source: new VectorSource({\n                features: features\n            }),\n            style: function (feature, resolution) {\n                return resolveStyle(feature, resolution, highlightStyle);\n            }\n        });\n        // Ensure layer is rendered on top of operational layers\n        layer.setZIndex(TOPMOST_LAYER_Z);\n        this.olMap.addLayer(layer);\n        this.currentHighlight = layer;\n    }\n}\n\nfunction setCenter(olMap: OlMap, coordinates: Coordinate | undefined) {\n    coordinates && coordinates.length && olMap.getView().setCenter(coordinates);\n}\n\nfunction zoomTo(olMap: OlMap, extent: Extent | undefined, zoomLevel: number | undefined) {\n    if (extent) {\n        const bufferedExtent: Extent | undefined = calculateBufferedExtent(extent);\n        bufferedExtent && olMap.getView().fit(bufferedExtent, { maxZoom: zoomLevel });\n    } else {\n        zoomLevel && olMap.getView().setZoom(zoomLevel);\n    }\n}\n\n/** Returns the appropriate style from the user's highlightStyle or falls back to the default style. */\nfunction resolveStyle(\n    feature: FeatureLike,\n    resolution: number,\n    highlightStyle: HighlightStyle | undefined\n) {\n    const type: keyof typeof defaultHighlightStyle = feature.get(\"type\");\n    const style = toStyleFunction(highlightStyle?.[type] ?? defaultHighlightStyle[type]);\n    return style(feature, resolution);\n}\n\nconst defaultHighlightStyle = {\n    \"Point\": new Style({\n        image: new Icon({\n            anchor: [0.5, 1],\n            src: mapMarkerUrl\n        })\n    }),\n    \"LineString\": [\n        new Style({\n            stroke: new Stroke({\n                color: \"#fff\",\n                width: 5\n            })\n        }),\n        new Style({\n            stroke: new Stroke({\n                color: \"#00ffff\",\n                width: 3\n            })\n        })\n    ],\n    \"Polygon\": [\n        new Style({\n            stroke: new Stroke({\n                color: \"#fff\",\n                width: 5\n            })\n        }),\n        new Style({\n            stroke: new Stroke({\n                color: \"#00ffff\",\n                width: 3\n            }),\n            fill: new Fill({\n                color: \"rgba(224,255,255,0.35)\"\n            })\n        })\n    ]\n};\n"],"names":["toStyleFunction"],"mappings":"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"}